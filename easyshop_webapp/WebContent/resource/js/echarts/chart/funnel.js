define("echarts/chart/funnel",["require","../component/base","./base","zrender/shape/Text","zrender/shape/Line","zrender/shape/Polygon","../config","../util/ecData","../util/number","zrender/tool/util","zrender/tool/color","zrender/tool/area","../chart"],function(u){function w(m,i,h,n,l){d.call(this,m,i,h,n,l),p.call(this),this.refresh(n)}var d=u("../component/base"),p=u("./base"),v=u("zrender/shape/Text"),c=u("zrender/shape/Line"),x=u("zrender/shape/Polygon"),b=u("../config"),k=u("../util/ecData"),q=u("../util/number"),g=u("zrender/tool/util"),f=u("zrender/tool/color"),j=u("zrender/tool/area");return w.prototype={type:b.CHART_TYPE_FUNNEL,_buildShape:function(){var o=this.series,m=this.component.legend;this._paramsMap={},this._selected={},this.selectedMap={};for(var r,l=0,h=o.length;h>l;l++){if(o[l].type===b.CHART_TYPE_FUNNEL){if(o[l]=this.reformOption(o[l]),this.legendHoverLink=o[l].legendHoverLink||this.legendHoverLink,r=o[l].name||"",this.selectedMap[r]=m?m.isSelected(r):!0,!this.selectedMap[r]){continue}this._buildSingleFunnel(l),this.buildMark(l)}}this.addShapeList()},_buildSingleFunnel:function(P){var D=this.component.legend,I=this.series[P],M=this._mapData(P),T=this._getLocation(P);this._paramsMap[P]={location:T,data:M};for(var H,E=0,F=[],K=0,J=M.length;J>K;K++){H=M[K].name,this.selectedMap[H]=D?D.isSelected(H):!0,this.selectedMap[H]&&!isNaN(M[K].value)&&(F.push(M[K]),E++)}if(0!==E){for(var h,z,Q,G,R=this._buildFunnelCase(P),C=I.funnelAlign,A=I.gap,N=E>1?(T.height-(E-1)*A)/E:T.height,S=T.y,O="descending"===I.sort?this._getItemWidth(P,F[0].value):q.parsePercent(I.minSize,T.width),L="descending"===I.sort?1:0,W=T.centerX,B=[],K=0,J=F.length;J>K;K++){if(H=F[K].name,this.selectedMap[H]&&!isNaN(F[K].value)){switch(h=J-2>=K?this._getItemWidth(P,F[K+L].value):"descending"===I.sort?q.parsePercent(I.minSize,T.width):q.parsePercent(I.maxSize,T.width),C){case"left":z=T.x;break;case"right":z=T.x+T.width-O;break;default:z=W-O/2}Q=this._buildItem(P,F[K]._index,D?D.getColor(H):this.zr.getColor(F[K]._index),z,S,O,h,N,C),S+=N+A,G=Q.style.pointList,B.unshift([G[0][0]-10,G[0][1]]),B.push([G[1][0]+10,G[1][1]]),0===K&&(0===O?(G=B.pop(),"center"==C&&(B[0][0]+=10),"right"==C&&(B[0][0]=G[0]),B[0][1]-="center"==C?10:15,1==J&&(G=Q.style.pointList)):(B[B.length-1][1]-=5,B[0][1]-=5)),O=h}}R&&(B.unshift([G[3][0]-10,G[3][1]]),B.push([G[2][0]+10,G[2][1]]),0===O?(G=B.pop(),"center"==C&&(B[0][0]+=10),"right"==C&&(B[0][0]=G[0]),B[0][1]+="center"==C?10:15):(B[B.length-1][1]+=5,B[0][1]+=5),R.style.pointList=B)}},_buildFunnelCase:function(o){var m=this.series[o];if(this.deepQuery([m,this.option],"calculable")){var r=this._paramsMap[o].location,l=10,h={hoverable:!1,style:{pointListd:[[r.x-l,r.y-l],[r.x+r.width+l,r.y-l],[r.x+r.width+l,r.y+r.height+l],[r.x-l,r.y+r.height+l]],brushType:"stroke",lineWidth:1,strokeColor:m.calculableHolderColor||this.ecTheme.calculableHolderColor}};return k.pack(h,m,o,void 0,-1),this.setCalculable(h),h=new x(h),this.shapeList.push(h),h}},_getLocation:function(A){var m,C=this.series[A],l=this.zr.getWidth(),h=this.zr.getHeight(),B=this.parsePercent(C.x,l),y=this.parsePercent(C.y,h);m=null==C.width?l-B-this.parsePercent(C.x2,l):this.parsePercent(C.width,l);var z;return z=null==C.height?h-y-this.parsePercent(C.y2,h):this.parsePercent(C.height,h),{x:B,y:y,width:m,height:z,centerX:B+m/2}},_mapData:function(y){function m(i,a){return"-"===i.value?1:"-"===a.value?-1:a.value-i.value}function A(a,i){return -m(a,i)}for(var l=this.series[y],h=g.clone(l.data),z=0,r=h.length;r>z;z++){h[z]._index=z}return"none"!=l.sort&&h.sort("descending"===l.sort?m:A),h},_buildItem:function(H,N,B,F,L,A,O,l,G){var D=this.series,C=D[H],E=C.data[N],I=this.getPolygon(H,N,B,F,L,A,O,l,G);k.pack(I,D[H],H,D[H].data[N],N,D[H].data[N].name),this.shapeList.push(I);var z=this.getLabel(H,N,B,F,L,A,O,l,G);k.pack(z,D[H],H,D[H].data[N],N,D[H].data[N].name),this.shapeList.push(z),this._needLabel(C,E,!1)||(z.invisible=!0);var J=this.getLabelLine(H,N,B,F,L,A,O,l,G);this.shapeList.push(J),this._needLabelLine(C,E,!1)||(J.invisible=!0);var M=[],K=[];return this._needLabelLine(C,E,!0)&&(M.push(J.id),K.push(J.id)),this._needLabel(C,E,!0)&&(M.push(z.id),K.push(I.id)),I.hoverConnect=M,z.hoverConnect=K,I},_getItemWidth:function(A,m){var C=this.series[A],l=this._paramsMap[A].location,h=C.min,B=C.max,y=q.parsePercent(C.minSize,l.width),z=q.parsePercent(C.maxSize,l.width);return m*(z-y)/(B-h)},getPolygon:function(L,B,F,I,P,E,C,H,J){var G,s=this.series[L],M=s.data[B],D=[M,s],N=this.deepMerge(D,"itemStyle.normal")||{},A=this.deepMerge(D,"itemStyle.emphasis")||{},z=this.getItemStyleColor(N.color,L,B,M)||F,K=this.getItemStyleColor(A.color,L,B,M)||("string"==typeof z?f.lift(z,-0.2):z);switch(J){case"left":G=I;break;case"right":G=I+(E-C);break;default:G=I+(E-C)/2}var O={zlevel:this._zlevelBase,clickable:this.deepQuery(D,"clickable"),style:{pointList:[[I,P],[I+E,P],[G+C,P+H],[G,P+H]],brushType:"both",color:z,lineWidth:N.borderWidth,strokeColor:N.borderColor},highlightStyle:{color:K,lineWidth:A.borderWidth,strokeColor:A.borderColor}};return this.deepQuery([M,s,this.option],"calculable")&&(this.setCalculable(O),O.draggable=!0),new x(O)},getLabel:function(P,C,H,K,G,D,E,I,M){var Q,F=this.series[P],R=F.data[C],B=this._paramsMap[P].location,z=g.merge(g.clone(R.itemStyle)||{},F.itemStyle),N="normal",S=z[N].label,O=S.textStyle||{},J=z[N].labelLine.length,T=this.getLabelText(P,C,N),A=this.getFont(O),m=H;S.position=S.position||z.normal.label.position,"inner"===S.position||"inside"===S.position||"center"===S.position?(Q=M,m=Math.max(D,E)/2>j.getTextWidth(T,A)?"#fff":f.reverse(H)):Q="left"===S.position?"right":"left";var a={zlevel:this._zlevelBase+1,style:{x:this._getLabelPoint(S.position,K,B,D,E,J,M),y:G+I/2,color:O.color||m,text:T,textAlign:O.align||Q,textBaseline:O.baseline||"middle",textFont:A}};return N="emphasis",S=z[N].label||S,O=S.textStyle||O,J=z[N].labelLine.length||J,S.position=S.position||z.normal.label.position,T=this.getLabelText(P,C,N),A=this.getFont(O),m=H,"inner"===S.position||"inside"===S.position||"center"===S.position?(Q=M,m=Math.max(D,E)/2>j.getTextWidth(T,A)?"#fff":f.reverse(H)):Q="left"===S.position?"right":"left",a.highlightStyle={x:this._getLabelPoint(S.position,K,B,D,E,J,M),color:O.color||m,text:T,textAlign:O.align||Q,textFont:A,brushType:"fill"},new v(a)},getLabelText:function(y,m,A){var l=this.series,h=l[y],z=h.data[m],r=this.deepQuery([z,h],"itemStyle."+A+".label.formatter");return r?"function"==typeof r?r.call(this.myChart,h.name,z.name,z.value):"string"==typeof r?(r=r.replace("{a}","{a0}").replace("{b}","{b0}").replace("{c}","{c0}"),r=r.replace("{a0}",h.name).replace("{b0}",z.name).replace("{c0}",z.value)):void 0:z.name},getLabelLine:function(L,B,F,H,P,C,D,G,I){var m=this.series[L],o=m.data[B],M=this._paramsMap[L].location,E=g.merge(g.clone(o.itemStyle)||{},m.itemStyle),N="normal",A=E[N].labelLine,z=E[N].labelLine.length,J=A.lineStyle||{},O=E[N].label;O.position=O.position||E.normal.label.position;var K={zlevel:this._zlevelBase+1,hoverable:!1,style:{xStart:this._getLabelLineStartPoint(H,M,C,D,I),yStart:P+G/2,xEnd:this._getLabelPoint(O.position,H,M,C,D,z,I),yEnd:P+G/2,strokeColor:J.color||F,lineType:J.type,lineWidth:J.width}};return N="emphasis",A=E[N].labelLine||A,z=E[N].labelLine.length||z,J=A.lineStyle||J,O=E[N].label||O,O.position=O.position,K.highlightStyle={xEnd:this._getLabelPoint(O.position,H,M,C,D,z,I),strokeColor:J.color||F,lineType:J.type,lineWidth:J.width},new c(K)},_getLabelPoint:function(y,m,A,l,h,z,r){switch(y="inner"===y||"inside"===y?"center":y){case"center":return"center"==r?m+l/2:"left"==r?m+10:m+l-10;case"left":return"auto"===z?A.x-10:"center"==r?A.centerX-Math.max(l,h)/2-z:"right"==r?m-(h>l?h-l:0)-z:A.x-z;default:return"auto"===z?A.x+A.width+10:"center"==r?A.centerX+Math.max(l,h)/2+z:"right"==r?A.x+A.width+z:m+Math.max(l,h)+z}},_getLabelLineStartPoint:function(o,m,r,l,h){return"center"==h?m.centerX:l>r?o+Math.min(r,l)/2:o+Math.max(r,l)/2},_needLabel:function(h,a,i){return this.deepQuery([a,h],"itemStyle."+(i?"emphasis":"normal")+".label.show")},_needLabelLine:function(h,a,i){return this.deepQuery([a,h],"itemStyle."+(i?"emphasis":"normal")+".labelLine.show")},refresh:function(a){a&&(this.option=a,this.series=a.series),this.backupShapeList(),this._buildShape()}},g.inherits(w,p),g.inherits(w,d),u("../chart").define("funnel",w),w});