define("echarts/chart/eventRiver",["require","../component/base","./base","../layout/eventRiver","zrender/shape/Polygon","../component/axis","../component/grid","../component/dataZoom","../config","../util/ecData","../util/date","zrender/tool/util","zrender/tool/color","../chart"],function(p){function u(n,i,h,w,l){d.call(this,n,i,h,w,l),j.call(this);var m=this;m._ondragend=function(){m.isDragend=!0},this.refresh(w)}var d=p("../component/base"),j=p("./base"),q=p("../layout/eventRiver"),c=p("zrender/shape/Polygon");p("../component/axis"),p("../component/grid"),p("../component/dataZoom");var v=p("../config"),b=p("../util/ecData"),g=p("../util/date"),k=p("zrender/tool/util"),f=p("zrender/tool/color");return u.prototype={type:v.CHART_TYPE_EVENTRIVER,_buildShape:function(){var l=this.series;this.selectedMap={},this._dataPreprocessing();for(var h=this.component.legend,r=[],a=0;a<l.length;a++){if(l[a].type===this.type){l[a]=this.reformOption(l[a]),this.legendHoverLink=l[a].legendHoverLink||this.legendHoverLink;var m=l[a].name||"";if(this.selectedMap[m]=h?h.isSelected(m):!0,!this.selectedMap[m]){continue}this.buildMark(a),r.push(this.series[a])}}q(r,this._intervalX,this.component.grid.getArea()),this._drawEventRiver(),this.addShapeList()},_dataPreprocessing:function(){for(var z,B,w=this.series,x=0,A=w.length;A>x;x++){if(w[x].type===this.type){z=this.component.xAxis.getAxis(w[x].xAxisIndex||0);for(var m=0,C=w[x].eventList.length;C>m;m++){B=w[x].eventList[m].evolution;for(var l=0,y=B.length;y>l;l++){B[l].timeScale=z.getCoord(g.getNewDate(B[l].time)-0),B[l].valueScale=Math.pow(B[l].value,0.8)}}}}this._intervalX=Math.round(this.component.grid.getWidth()/40)},_drawEventRiver:function(){for(var l=this.series,h=0;h<l.length;h++){var m=l[h].name||"";if(l[h].type===this.type&&this.selectedMap[m]){for(var a=0;a<l[h].eventList.length;a++){this._drawEventBubble(l[h].eventList[a],h,a)}}}},_drawEventBubble:function(C,I,o){var z=this.series,G=z[I],J=G.name||"",x=G.eventList[o],A=[x,G],r=this.component.legend,w=r?r.getColor(J):this.zr.getColor(I),D=this.deepMerge(A,"itemStyle.normal")||{},m=this.deepMerge(A,"itemStyle.emphasis")||{},E=this.getItemStyleColor(D.color,I,o,x)||w,H=this.getItemStyleColor(m.color,I,o,x)||("string"==typeof E?f.lift(E,-0.2):E),F=this._calculateControlPoints(C),B={zlevel:this._zlevelBase,clickable:this.deepQuery(A,"clickable"),style:{pointList:F,smooth:"spline",brushType:"both",lineJoin:"round",color:E,lineWidth:D.borderWidth,strokeColor:D.borderColor},highlightStyle:{color:H,lineWidth:m.borderWidth,strokeColor:m.borderColor},draggable:"vertical",ondragend:this._ondragend};B=new c(B),this.addLabel(B,G,x,C.name),b.pack(B,z[I],I,z[I].eventList[o],o,z[I].eventList[o].name),this.shapeList.push(B)},_calculateControlPoints:function(z){var B=this._intervalX,w=z.y,y=z.evolution,A=y.length;if(!(1>A)){for(var m=[],C=[],h=0;A>h;h++){m.push(y[h].timeScale),C.push(y[h].valueScale)}var x=[];x.push([m[0],w]);var h=0;for(h=0;A-1>h;h++){x.push([(m[h]+m[h+1])/2,C[h]/-2+w])}for(x.push([(m[h]+(m[h]+B))/2,C[h]/-2+w]),x.push([m[h]+B,w]),x.push([(m[h]+(m[h]+B))/2,C[h]/2+w]),h=A-1;h>0;h--){x.push([(m[h]+m[h-1])/2,C[h-1]/2+w])}return x}},ondragend:function(h,a){this.isDragend&&h.target&&(a.dragOut=!0,a.dragIn=!0,a.needRefresh=!1,this.isDragend=!1)},refresh:function(a){a&&(this.option=a,this.series=a.series),this.backupShapeList(),this._buildShape()}},k.inherits(u,j),k.inherits(u,d),p("../chart").define("eventRiver",u),u}),define("echarts/layout/eventRiver",["require"],function(){function f(G,z,t){function v(l,k){var m=l.importance,h=k.importance;return m>h?-1:h>m?1:0}function B(l,k){if(l.indexOf){return l.indexOf(k)}for(var m=0,h=l.length;h>m;m++){if(l[m]===k){return m}}return -1}for(var D=5,A=z,a=0;a<G.length;a++){for(var i=0;i<G[a].eventList.length;i++){null==G[a].eventList[i].weight&&(G[a].eventList[i].weight=1);for(var H=0,w=0;w<G[a].eventList[i].evolution.length;w++){H+=G[a].eventList[i].evolution[w].valueScale}G[a].eventList[i].importance=H*G[a].eventList[i].weight}G[a].eventList.sort(v)}for(var a=0;a<G.length;a++){null==G[a].weight&&(G[a].weight=1);for(var H=0,i=0;i<G[a].eventList.length;i++){H+=G[a].eventList[i].weight}G[a].importance=H*G[a].weight}G.sort(v);for(var I=Number.MAX_VALUE,q=0,a=0;a<G.length;a++){for(var i=0;i<G[a].eventList.length;i++){for(var w=0;w<G[a].eventList[i].evolution.length;w++){var j=G[a].eventList[i].evolution[w].timeScale;I=Math.min(I,j),q=Math.max(q,j)}}}for(var E=g(Math.floor(I),Math.ceil(q)),J=0,a=0;a<G.length;a++){for(var i=0;i<G[a].eventList.length;i++){var F=G[a].eventList[i];F.time=[],F.value=[];for(var w=0;w<G[a].eventList[i].evolution.length;w++){F.time.push(G[a].eventList[i].evolution[w].timeScale),F.value.push(G[a].eventList[i].evolution[w].valueScale)}var C=B(F.value,Math.max.apply(Math,F.value)),K=c(E,F.time[C],F.time[C+1]),w=0;for(F.y=K+F.value[C]/2+D,w=0;w<F.time.length-1;w++){var n=c(E,F.time[w],F.time[w+1]);F.y-F.value[w]/2-D<n&&(F.y=n+F.value[w]/2+D)}var n=c(E,F.time[w],F.time[w]+A);for(F.y-F.value[w]/2-D<n&&(F.y=n+F.value[w]/2+D),G[a].y=F.y,J=Math.max(J,F.y+F.value[C]/2),w=0;w<F.time.length-1;w++){b(E,F.time[w],F.time[w+1],F.y+F.value[w]/2)}b(E,F.time[w],F.time[w]+A,F.y+F.value[w]/2)}}d(G,t,J,D)}function d(x,z,p,v){for(var y=z.y,k=(z.height-v)/p,A=0;A<x.length;A++){x[A].y=x[A].y*k+y;for(var j=x[A].eventList,u=0;u<j.length;u++){j[u].y=j[u].y*k+y;for(var w=j[u].evolution,q=0;q<w.length;q++){w[q].valueScale*=1*k}}}}function g(l,k){var j={left:l,right:k,leftChild:null,rightChild:null,maxValue:0};if(k>l+1){var h=Math.round((l+k)/2);j.leftChild=g(l,h),j.rightChild=g(h,k)}return j}function c(l,i,p){if(1>p-i){return 0}var h=Math.round((l.left+l.right)/2),m=0;if(i==l.left&&p==l.right){m=l.maxValue}else{if(h>=p&&null!=l.leftChild){m=c(l.leftChild,i,p)}else{if(i>=h&&null!=l.rightChild){m=c(l.rightChild,i,p)}else{var j=0,k=0;null!=l.leftChild&&(j=c(l.leftChild,i,h)),null!=l.rightChild&&(k=c(l.rightChild,h,p)),m=j>k?j:k}}}return m}function b(j,h,l,a){if(null!=j){var k=Math.round((j.left+j.right)/2);j.maxValue=j.maxValue>a?j.maxValue:a,(Math.floor(10*h)!=Math.floor(10*j.left)||Math.floor(10*l)!=Math.floor(10*j.right))&&(k>=l?b(j.leftChild,h,l,a):h>=k?b(j.rightChild,h,l,a):(b(j.leftChild,h,k,a),b(j.rightChild,k,l,a)))}}return f});